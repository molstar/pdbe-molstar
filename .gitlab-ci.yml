stages:
  - publish

npm_publish:
  stage: publish
  only:
    - tags
  image: node:20
  script:
    - PKG_VERSION=$(node -e 'console.log(JSON.parse(fs.readFileSync("package.json")).version)')
    - echo 'Package version:' $PKG_VERSION
    - echo 'Tag:' $CI_COMMIT_TAG
    - test "$CI_COMMIT_TAG" = "v$PKG_VERSION"  # Ensure the git tag matches the npm package version (e.g. tag v1.0.0 for version 1.0.0)
    - npm ci --omit optional
    - npm run lint
    - npm run rebuild
    - npm config set -- '//registry.npmjs.org/:_authToken'="${NPM_AUTH_TOKEN}"
    - npm publish --verbose
